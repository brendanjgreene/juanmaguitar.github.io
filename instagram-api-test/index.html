<!DOCTYPE html>
<html lang="en-ca">
<head>
	<meta charset="utf-8">
	<title>Test Instagram API</title>
	<script src="https://code.jquery.com/jquery-2.0.3.min.js"></script>
	<link rel="stylesheet" href="styles.css">
	<style>
		.hidden { display:none; }
	</style>
</head>
<body>

	<form>
		<fieldset>
			<legend>Insert your SoundCloud API data</legend>
			<ul>
					<li>
							<label>Client ID</label>
							<input id="client_id" size="50">
					</li>
			</ul>
		</fieldset>
	</form>

	<button class="hidden" id="connect">connect!</button>

	<div id="my-photos"></div>


	<!-- @begin card template -->
	<template id="card-instagram">

		<div id="{{id}}" class="instagram_container">
				<div id="{{id}}">
						<a href="{{link}}" target="_blank" title="{{caption}} by {{username}}"> <img src="{{image}}" alt="{{caption}} by {{username}}" class="instagram_image" /> </a>
				</div>
				<div class="instagram_image_meta">
						<div class="likes instagram_image_meta_item">
								<p>
									<a class="icon-heart" href="{{link}}" target="_blank" title="{{caption}}">{{likes}}</a>
								</p>
						</div>
						<div class="comments instagram_image_meta_item">
								<p>
									<a class="icon-bubble" href="{{link}}" target="_blank" title="{{caption}}">{{comments}}</a>
								</p>
						</div>
						<div class="owner instagram_image_meta_item">
								<p>
									<a href="http://instagram.com/{{username}}" target="_blank" title="{{user_full-name}}"> <img src="{{username_profile_picture}}" class="owner_profile_picture" /> {{user_full-name}} </a>
								</p>
						</div>
						<div class="caption instagram_image_meta_item">
								<p> {{caption}} </p>
						</div>
				</div>
		</div>
	</template>
	<!-- @end card template -->

	<script type="text/javascript">

		var currentUrl = location.href;
		var token, sUrlRecentPhotos;
		var sCardTemplate = $("#card-instagram").html();
		var sClientId;

		sClientId = localStorage.getItem("instagramClientId");
		sClientId ? $("#client_id").val(sClientId) : "";

		if ( currentUrl.indexOf("#access_token=") != -1 ) {
			token = currentUrl.split("#access_token=")[1]
		}

		var sUrlApiInstgram = "https://api.instagram.com/oauth/authorize/";
		sUrlApiInstgram += "?client_id=<%CLIENT-ID%>";
		sUrlApiInstgram += "&redirect_uri=<%REDIRECT-URL%>"
		sUrlApiInstgram += "&response_type=token";

		console.log (sClientId)
		console.log (currentUrl)

		if (token) {

			sUrlRecentPhotos = "https://api.instagram.com/v1/users/2094276/media/recent";
			sUrlRecentPhotos += "?access_token=" + token

			$.ajax({
				url: sUrlRecentPhotos,
				dataType: "jsonp",
				success: function(oData) {
					var aPhotos = oData.data;
					var sHtmlTotal = "", sHtmlCard;

					localStorage.setItem("instagramClientId",sClientId);

					$.each(aPhotos, function(index, oPhoto) {
						oPhoto.caption ? null : $.extend(oPhoto, { caption : { text : "" } } );
						sHtmlCard = sCardTemplate;
						sHtmlCard = sHtmlCard.replace(/\{\{id\}\}/g, oPhoto.id);
						sHtmlCard = sHtmlCard.replace(/\{\{link\}\}/g, oPhoto.link);
						sHtmlCard = sHtmlCard.replace(/\{\{caption\}\}/g, oPhoto.caption.text);
						sHtmlCard = sHtmlCard.replace(/\{\{image\}\}/g, oPhoto.images.standard_resolution.url);
						sHtmlCard = sHtmlCard.replace(/\{\{comments\}\}/g, oPhoto.comments.count);
						sHtmlCard = sHtmlCard.replace(/\{\{likes\}\}/g, oPhoto.likes.count);
						sHtmlCard = sHtmlCard.replace(/\{\{username\}\}/g, oPhoto.user.username);
						sHtmlCard = sHtmlCard.replace(/\{\{username_profile_picture\}\}/g, oPhoto.user.profile_picture);
						sHtmlCard = sHtmlCard.replace(/\{\{user_full-name\}\}/g, oPhoto.user.full_name);
						sHtmlCard = sHtmlCard.replace(/\@\{\{model\.user\.full_name\}\}/g, oPhoto.user.full_name);
						console.log (oPhoto);
						sHtmlTotal += sHtmlCard;
					})
					$("#my-photos").html(sHtmlTotal);
				}
			});

		}
		else {

			$("#connect")

				.on("click", function(e) {

					e.preventDefault();

					var sClientId = $("#client_id").val();

					if (sClientId=="") {
						alert("Please, write a valid SoundCloud API KEY");
						return false;
					}
					else {
						localStorage.setItem("instagramClientId",sClientId);
					}

					sUrlApiInstgram = sUrlApiInstgram.replace("<%CLIENT-ID%>", sClientId );
					sUrlApiInstgram = sUrlApiInstgram.replace("<%REDIRECT-URL%>", currentUrl );

					window.location.replace(sUrlApiInstgram);
				})
				.removeClass("hidden");

		}

	</script>
</body>
</html>